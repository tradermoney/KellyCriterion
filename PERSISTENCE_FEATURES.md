# 凯利公式计算器 - 持久化功能说明

## 概述

本应用已全面集成IndexedDB持久化功能，确保用户的所有输入和设置都能在下次访问时自动恢复。所有组件都支持数据持久化，提供无缝的用户体验。

## 持久化的数据

### 1. 基础参数配置
- **初始资金** (initialWealth)
- **仿真次数** (paths)
- **胜率** (winProb)
- **赔率** (odds)
- **手续费率** (feeRate)
- **最大下注比例** (fMax)
- **轮次** (rounds)
- **破产阈值** (ruinThreshold)

### 2. 策略配置
- **策略类型** (kelly, fractionalKelly, fixedFraction, fixedStake, paroli, martingale)
- **策略参数** (alpha, fFixed, base, k, r等)
- **策略数量** 和 **策略顺序**

### 3. 仿真控制状态
- **自动保存结果** 开关
- **上次仿真时间**
- **仿真进度** (运行时)

### 4. 导出设置
- **文件名前缀**
- **JSON包含元数据** 选项
- **JSON包含原始数据** 选项
- **上次导出时间**

### 5. 用户界面偏好
- **主题设置** (亮色/暗色)
- **语言设置** (中文/英文)

### 6. 仿真结果
- **完整的仿真结果** (如果启用自动保存)
- **统计数据** 和 **图表数据**

## 技术实现

### IndexedDB存储结构
```typescript
数据库名称: KellyCriterionDB
版本: 1
对象存储: appState
索引: timestamp
```

### 存储键常量
```typescript
STORAGE_KEYS = {
  SIMULATION_CONFIG: 'simulation_config',    // 仿真配置
  THEME: 'theme',                           // 主题设置
  LANGUAGE: 'language',                     // 语言设置
  LAST_RESULT: 'last_result',               // 上次结果
  CONTROL_STATE: 'control_state',           // 控制状态
  EXPORT_SETTINGS: 'export_settings',       // 导出设置
  UI_PREFERENCES: 'ui_preferences',         // UI偏好
  CHART_SETTINGS: 'chart_settings',         // 图表设置
}
```

### 自动保存机制
- **实时保存**: 用户修改参数时立即保存
- **批量保存**: 策略配置变更时批量保存
- **结果保存**: 仿真完成后自动保存结果
- **设置保存**: 用户偏好变更时立即保存

## 用户体验特性

### 1. 自动恢复
- 页面刷新后自动恢复所有设置
- 浏览器重启后保持用户配置
- 跨会话数据持久化

### 2. 状态指示
- 实时显示数据保存状态
- 存储异常时显示警告
- 开发环境下显示详细存储信息

### 3. 降级支持
- IndexedDB不可用时自动降级到localStorage
- 存储失败时显示错误提示
- 优雅的错误处理机制

### 4. 性能优化
- 异步存储操作，不阻塞UI
- 批量数据更新，减少存储次数
- 智能缓存机制

## 开发工具

### 持久化测试工具
```typescript
import { persistenceTester } from './utils/persistenceTest';

// 运行所有测试
await persistenceTester.runAllTests();

// 清理测试数据
await persistenceTester.cleanup();
```

### 存储状态监控
- 实时监控IndexedDB状态
- 自动检测存储异常
- 开发环境下详细日志

## 使用方法

### 1. 基本使用
用户无需任何操作，所有数据会自动保存和恢复。

### 2. 手动控制
```typescript
// 在仿真控制面板中
- 开启/关闭自动保存结果
- 查看上次仿真时间
- 监控存储状态
```

### 3. 导出设置
```typescript
// 在导出面板中
- 自定义文件名前缀
- 选择JSON导出选项
- 查看导出历史
```

## 数据安全

### 1. 本地存储
- 所有数据存储在用户本地浏览器中
- 不会上传到任何服务器
- 完全保护用户隐私

### 2. 数据备份
- 支持手动导出所有数据
- 可导出为JSON格式进行备份
- 支持数据迁移和恢复

### 3. 清理机制
- 用户可手动清理所有存储数据
- 支持选择性数据清理
- 提供数据重置功能

## 浏览器兼容性

### 支持的浏览器
- Chrome 24+
- Firefox 16+
- Safari 10+
- Edge 12+

### 降级方案
- 不支持IndexedDB的浏览器自动使用localStorage
- 存储空间限制时提供警告
- 优雅的兼容性处理

## 故障排除

### 常见问题
1. **数据未保存**: 检查浏览器存储权限
2. **存储空间不足**: 清理浏览器缓存
3. **数据丢失**: 检查浏览器隐私模式设置

### 调试工具
- 开发环境下自动运行存储测试
- 控制台显示详细存储日志
- 实时监控存储状态

## 未来扩展

### 计划功能
- 云端数据同步
- 多设备数据共享
- 数据版本管理
- 高级备份选项

### 性能优化
- 数据压缩存储
- 增量更新机制
- 智能缓存策略
- 存储空间优化

---

**注意**: 持久化功能完全在客户端运行，不会向任何服务器发送用户数据，确保用户隐私和数据安全。

